<!doctype html>
<!-- ‚òÖ MARCADOR: punto que me gusta -->
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ARC Raiders Crafting, Uses & Recycling | Inventory Planner</title>
  <meta name="description"
    content="Interactive crafting, item-uses, and recycling tree for ARC Raiders inventory management. Plan materials, upgrades, and inventory needs with a visual board.">
  <meta property="og:type" content="website">
  <meta property="og:title" content="ARC Raiders Crafting, Uses & Recycling | Inventory Planner">
  <meta property="og:description"
    content="Interactive crafting, item-uses, and recycling tree for ARC Raiders inventory management. Plan materials, upgrades, and inventory needs with a visual board.">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ARC Raiders Crafting, Uses & Recycling | Inventory Planner">
  <meta name="twitter:description"
    content="Interactive crafting, item-uses, and recycling tree for ARC Raiders inventory management. Plan materials, upgrades, and inventory needs with a visual board.">
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "ARC Raiders Crafting, Uses & Recycling",
      "applicationCategory": "GameApplication",
      "operatingSystem": "Web",
      "description": "Interactive crafting, item-uses, and recycling tree for ARC Raiders inventory management. Plan materials, upgrades, and inventory needs with a visual board.",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      }
    }
  </script>
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "How do I use the crafting board?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Switch to Crafting, drag an item from the left list to the board, and the tree will show required materials and previous levels."
          }
        },
        {
          "@type": "Question",
          "name": "How do I see what an item is used for?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Switch to Uses, drop an item on the board, and expand layers with the + button to see what it can craft."
          }
        },
        {
          "@type": "Question",
          "name": "How do I see what recycles into a material?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Switch to Recycling, drop a target material on the board, and the tree will list items that recycle into it."
          }
        }
      ]
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap');

    :root {
      --bg: #121212;
      --sidebar-bg: rgba(22, 22, 24, 0.95);
      --border: rgba(255, 255, 255, 0.06);
      --ink: #e0e0e0;
      --muted: #71717a;
      --accent: #3b82f6;
      --accent-hi: #60a5fa;
      --accent-glow: rgba(59, 130, 246, 0.35);
      --accent-tint-strong: rgba(59, 130, 246, 0.2);
      --accent-tint: rgba(59, 130, 246, 0.15);
      --accent-tint-weak: rgba(59, 130, 246, 0.08);
      --accent-tint-min: rgba(59, 130, 246, 0.03);
      --accent-2: #00ffa3;
      --craft: #00ffa3;
      --loot: #ffb800;
      --common: #8e949e;
      --uncommon: #4ade80;
      --rare: #60a5fa;
      --epic: #c084fc;
      --legendary: #fbbf24;
      --line: rgba(255, 255, 255, 0.08);
      --sidebar-width: 340px;
      --speed: 0.35s;
      --ease: cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      scrollbar-width: thin;
      scrollbar-color: var(--line) transparent;
    }

    *::-webkit-scrollbar {
      width: 5px;
    }

    *::-webkit-scrollbar-track {
      background: transparent;
    }

    *::-webkit-scrollbar-thumb {
      background: var(--line);
      border-radius: 10px;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: "Outfit", sans-serif;
      color: var(--ink);
      background: var(--bg);
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    .is-hidden {
      display: none !important;
    }

    /* Textured Background - Dark Grid / Dots */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(circle at 1.5px 1.5px, rgba(255, 255, 255, 0.06) 1.5px, transparent 0);
      background-size: 30px 30px;
      pointer-events: none;
      z-index: 0;
    }

    /* Removed previous title overlay and header related styles */
    .app-title-overlay {
      display: none;
    }

    main {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      z-index: 1;
    }

    /* Sidebar - Flush mount */
    .sidebar {
      width: var(--sidebar-width);
      height: 100%;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      backdrop-filter: blur(25px);
      transition: transform var(--speed) var(--ease), margin var(--speed) var(--ease);
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 50;
      flex: 0 0 auto;
    }

    body.menu-collapsed .sidebar {
      transform: translateX(-100%);
      margin-right: calc(-1 * var(--sidebar-width));
    }

    /* Toggle Button - Arrow style */
    .toggle-sidebar-btn,
    .toggle-summary-btn {
      position: absolute;
      top: 50%;
      width: 24px;
      height: 48px;
      background: var(--sidebar-bg);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--muted);
      transition: all 0.2s;
      z-index: 60;
      transform: translateY(-50%);
    }

    .toggle-sidebar-btn {
      right: -24px;
      border-left: none;
      border-radius: 0 8px 8px 0;
    }

    .toggle-summary-btn {
      left: -24px;
      border-right: none;
      border-radius: 8px 0 0 8px;
    }

    .toggle-sidebar-btn:hover,
    .toggle-summary-btn:hover {
      color: var(--ink);
      background: #1e1e20;
    }

    .toggle-sidebar-btn svg,
    .toggle-summary-btn svg {
      width: 14px;
      height: 14px;
      transition: transform 0.3s var(--ease);
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    body.menu-collapsed .toggle-sidebar-btn svg {
      transform: rotate(180deg);
    }

    body.summary-collapsed .toggle-summary-btn svg {
      transform: rotate(180deg);
    }

    .sidebar-inner {
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .sidebar h2 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .filters {
      margin-bottom: 20px;
    }

    .guide-btn {
      margin-top: 8px;
      width: 100%;
      padding: 8px 12px;
      font-size: 0.85rem;
      border-radius: 10px;
    }

    .guide-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 200;
    }

    .guide-modal.open {
      opacity: 1;
      pointer-events: auto;
    }

    .guide-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(10, 10, 12, 0.7);
      backdrop-filter: blur(6px);
    }

    .guide-dialog {
      position: relative;
      width: min(900px, 92vw);
      max-height: 85vh;
      overflow: hidden;
      background: rgba(18, 18, 20, 0.98);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
      z-index: 1;
      display: flex;
      flex-direction: column;
    }

    .guide-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .guide-header h2 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .guide-close {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--ink);
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
    }

    .guide-close:hover {
      border-color: var(--accent-2);
      box-shadow: 0 0 0 2px rgba(0, 255, 163, 0.12);
    }

    .guide-content {
      padding: 18px 20px 24px;
      overflow: auto;
    }

    .guide-content h3 {
      margin: 18px 0 6px;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
    }

    .guide-content p,
    .guide-content li {
      font-size: 0.9rem;
      line-height: 1.55;
      color: var(--ink);
    }

    .guide-content ul,
    .guide-content ol {
      margin: 8px 0 0 18px;
      padding: 0;
    }

    html[lang="en"] .lang-es {
      display: none;
    }

    html[lang="es"] .lang-en {
      display: none;
    }

    .board-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 220;
    }

    .board-modal.open {
      opacity: 1;
      pointer-events: auto;
    }

    .board-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(10, 10, 12, 0.7);
      backdrop-filter: blur(6px);
    }

    .board-dialog {
      position: relative;
      width: min(420px, 92vw);
      background: rgba(18, 18, 20, 0.98);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
      z-index: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 16px 18px 20px;
    }

    .modal-body label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .modal-body input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.3);
      color: var(--ink);
      font-family: inherit;
      font-size: 0.9rem;
    }

    .modal-body input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(0, 0, 0, 0.45);
    }

    .modal-hint {
      font-size: 0.82rem;
      color: var(--muted);
      margin: 0;
    }

    .modal-error {
      font-size: 0.8rem;
      color: #ff9c9c;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    input[type="search"] {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.25);
      color: var(--ink);
      font-family: inherit;
      font-size: 0.95rem;
      transition: all 0.2s;
    }

    input[type="search"]:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(0, 0, 0, 0.4);
    }

    .filter-options {
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .category-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 5px;
    }

    details.category {
      margin-bottom: 5px;
      border-radius: 8px;
      overflow: hidden;
    }

    details.category summary {
      cursor: pointer;
      padding: 10px 12px;
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      list-style: none;
      border-radius: 8px;
      transition: background 0.2s;
    }

    details.category summary:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    details.category summary::after {
      content: "\203A";
      font-size: 1.4rem;
      color: var(--muted);
      transition: transform 0.3s;
    }

    details.category[open] summary::after {
      transform: rotate(90deg);
      color: var(--accent);
    }

    .item-list {
      padding: 4px;
      display: grid;
      gap: 4px;
      list-style: none;
      margin: 0;
    }

    .item-list li {
      padding: 8px 10px;
      border-radius: 8px;
      cursor: grab;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .item-list li:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .item-list img {
      width: 24px;
      height: 24px;
      border-radius: 5px;
      background: #000;
    }

    .tag {
      font-size: 0.6rem;
      padding: 1px 5px;
      border-radius: 4px;
      margin-left: auto;
      font-weight: 700;
      opacity: 0.8;
    }

    .tag.craft {
      background: rgba(0, 255, 163, 0.1);
      color: var(--craft);
    }

    .tag.loot {
      background: rgba(255, 184, 0, 0.1);
      color: var(--loot);
    }

    .tag.recycle {
      background: rgba(92, 200, 255, 0.1);
      color: #5cc8ff;
    }

    /* Workspace - The Pizarra */
    .workspace {
      flex: 1;
      height: 100%;
      position: relative;
      z-index: 10;
      display: flex;
      overflow: visible;
      min-width: 0;
    }

    .workspace-canvas {
      flex: 1;
      height: 100%;
      position: relative;
      overflow: hidden;
      min-width: 0;
    }

    .board-switcher {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 90;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(18, 18, 20, 0.85);
      backdrop-filter: blur(20px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.55);
    }

    .session-bar {
      display: none;
      /* Moved to bottom-left-group */
    }

    /* Share banner for imported boards */
    .share-banner {
      position: absolute;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 115;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      border-radius: 14px;
      border: 1px solid var(--accent-2);
      background: rgba(0, 255, 163, 0.08);
      backdrop-filter: blur(20px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .share-banner span {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent-2);
    }

    .share-banner .button {
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    .share-dismiss {
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
    }

    .share-dismiss:hover {
      color: var(--ink);
    }

    .board-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .board-btn.active {
      color: #fff;
      background: var(--accent);
      box-shadow: 0 6px 18px var(--accent-glow);
    }

    .board-btn:hover:not(.active) {
      color: var(--ink);
      background: rgba(255, 255, 255, 0.08);
    }

    .workspace-header {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 12px;
      pointer-events: none;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       UNIFIED CONTROL PANEL - Bottom Left (Always Visible)
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    .control-panel {
      position: fixed;
      bottom: 24px;
      left: 24px;
      z-index: 9999;
    }

    .control-trigger {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hi));
      border: none;
      color: #fff;
      font-size: 1.4rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 30px var(--accent-glow), 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .control-trigger:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 40px var(--accent-glow);
    }

    .control-trigger .icon-open {
      display: block;
    }

    .control-trigger .icon-close {
      display: none;
    }

    .control-panel.is-open .control-trigger .icon-open {
      display: none;
    }

    .control-panel.is-open .control-trigger .icon-close {
      display: block;
    }

    .control-panel.is-open .control-trigger {
      background: linear-gradient(135deg, #333, #222);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .control-content {
      position: absolute;
      bottom: calc(100% + 12px);
      left: 0;
      width: 360px;
      max-height: 500px;
      background: linear-gradient(145deg, rgba(24, 24, 28, 0.98), rgba(16, 16, 20, 0.99));
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.7), inset 0 1px 0 rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(40px);
      transform: translateY(20px) scale(0.95);
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .control-panel.is-open .control-content {
      transform: translateY(0) scale(1);
      opacity: 1;
      pointer-events: auto;
    }

    .control-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .control-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--ink);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .current-board-badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      background: var(--accent-tint);
      border: 1px solid var(--accent);
      border-radius: 20px;
      color: var(--accent);
      font-weight: 600;
    }

    .control-actions {
      display: flex;
      gap: 8px;
    }

    .control-btn {
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: var(--ink);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .control-btn.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-hi));
      border-color: transparent;
      color: #fff;
    }

    .control-btn.primary:hover {
      box-shadow: 0 6px 20px var(--accent-glow);
    }

    .boards-section {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .boards-section-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      padding: 8px 8px 12px;
    }

    .board-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid transparent;
      margin-bottom: 8px;
      transition: all 0.2s ease;
      position: relative;
    }

    .board-card:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .board-card.active {
      background: linear-gradient(135deg, var(--accent-tint), color-mix(in srgb, var(--accent-tint-weak), transparent 25%));
      border-color: var(--accent);
    }

    .board-card-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .board-card.active .board-card-icon {
      background: var(--accent-tint-strong);
    }

    .board-card-info {
      flex: 1;
      min-width: 0;
    }

    .board-card-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--ink);
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      text-align: left;
      width: 100%;
    }

    .board-card-name:hover {
      color: #fff;
    }

    .board-card-meta {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 2px;
    }

    .board-card-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .board-card:hover .board-card-actions {
      opacity: 1;
    }

    .board-action-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.06);
      border: none;
      color: var(--muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      transition: all 0.2s;
      position: relative;
    }

    .board-action-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      color: var(--ink);
    }

    .board-action-btn.delete:hover {
      background: rgba(255, 100, 100, 0.15);
      color: #ff9c9c;
    }

    /* Share Dropdown */
    .share-dropdown {
      position: absolute;
      bottom: calc(100% + 8px);
      right: 0;
      width: 180px;
      background: rgba(22, 22, 26, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      padding: 8px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(30px);
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: all 0.2s ease;
      z-index: 10;
    }

    .share-dropdown.is-open {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .share-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      background: transparent;
      border: none;
      color: var(--ink);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      text-align: left;
      transition: background 0.2s;
    }

    .share-option:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .share-option .share-icon {
      width: 24px;
      text-align: center;
      font-size: 1rem;
    }

    .boards-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .boards-empty-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .boards-empty-text {
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .boards-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--ink);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .boards-title::before {
      content: 'üìÅ';
    }

    .boards-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 280px;
      overflow-y: auto;
      padding-right: 6px;
    }

    .board-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }

    .board-row:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .board-row.active {
      background: linear-gradient(135deg, var(--accent-tint), var(--accent-tint-weak));
      border-color: var(--accent);
    }

    .board-item {
      flex: 1;
      background: none;
      border: none;
      color: var(--ink);
      font-size: 0.9rem;
      font-weight: 600;
      text-align: left;
      cursor: pointer;
      padding: 0;
    }

    .board-delete {
      opacity: 0;
      background: transparent;
      border: none;
      color: var(--muted);
      padding: 4px 8px;
      font-size: 0.85rem;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .board-row:hover .board-delete {
      opacity: 1;
    }

    .board-delete:hover {
      background: rgba(255, 100, 100, 0.15);
      color: #ff9c9c;
    }

    .boards-empty {
      text-align: center;
      padding: 30px 20px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SELECTION BAR - Fixed Center Bottom
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    .selection-bar {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      z-index: 999;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 10px 8px 18px;
      background: linear-gradient(135deg, rgba(28, 28, 32, 0.95), rgba(18, 18, 22, 0.98));
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      backdrop-filter: blur(30px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.05);
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .selection-bar.has-items {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .selected-chips {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      max-width: 450px;
      padding: 4px 0;
      scrollbar-width: none;
    }

    .selected-chips::-webkit-scrollbar {
      display: none;
    }

    .chip {
      flex: 0 0 auto;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      font-size: 0.82rem;
      font-weight: 500;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .chip:hover {
      background: rgba(255, 255, 255, 0.12);
    }

    .chip button {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      font-size: 1rem;
      line-height: 1;
      transition: color 0.2s;
    }

    .chip button:hover {
      color: #fff;
    }

    .selection-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      padding-left: 8px;
      border-left: 1px solid rgba(255, 255, 255, 0.1);
    }

    .selection-btn {
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .selection-btn.ghost {
      background: rgba(255, 255, 255, 0.06);
      color: var(--ink);
    }

    .selection-btn.ghost:hover {
      background: rgba(255, 255, 255, 0.12);
    }

    .selection-btn.danger {
      background: linear-gradient(135deg, var(--accent), var(--accent-hi));
      color: #fff;
    }

    .selection-btn.danger:hover {
      box-shadow: 0 6px 20px var(--accent-glow);
    }

    @media (max-width: 720px) {
      .floating-menu {
        bottom: 20px;
        left: 20px;
      }

      .boards-drawer {
        left: 20px;
        bottom: 90px;
      }

      .boards-panel {
        width: calc(100vw - 40px);
        max-width: 360px;
      }

      .selection-bar {
        max-width: calc(100vw - 40px);
        bottom: 20px;
      }

      .selected-chips {
        max-width: 200px;
      }
    }

    #tree {
      width: 100%;
      height: 100%;
      background: transparent;
      cursor: crosshair;
    }

    /* Summary - Minimal Float & Collapsible */
    .summary-panel {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      width: clamp(280px, var(--summary-width, 320px), 80vw);
      background: var(--sidebar-bg);
      border-left: 1px solid var(--border);
      padding: 20px;
      backdrop-filter: blur(25px);
      transition: transform var(--speed) var(--ease);
      z-index: 90;
      display: flex;
      flex-direction: column;
    }

    .summary-resizer {
      position: absolute;
      top: 0;
      left: -5px;
      width: 10px;
      height: 100%;
      cursor: ew-resize;
      z-index: 100;
    }

    .summary-resizer:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .summary-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .summary-header h3 {
      margin: 0 !important;
    }

    .sort-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.7rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
    }

    .sort-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .sort-btn.active {
      color: var(--accent);
      border-color: var(--accent);
    }

    body.summary-collapsed .summary-panel {
      transform: translateX(100%);
    }

    .summary-scroll {
      flex: 1;
      overflow-y: auto;
      margin-right: -10px;
      padding-right: 10px;
    }

    .summary-panel h3 {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      margin: 0 0 16px;
    }

    .summary-panel h4 {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      margin: 24px 0 12px;
    }

    .summary-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 8px;
    }

    .summary-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid transparent;
      font-size: 0.85rem;
      min-height: 48px;
    }

    .summary-item img {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      margin-top: 2px;
      flex-shrink: 0;
    }

    .summary-item .item-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-item .name {
      font-weight: 500;
      line-height: 1.2;
      color: #fff;
      overflow-wrap: break-word;
    }

    .summary-item .meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .summary-item .qty {
      color: var(--accent-2);
      font-weight: 700;
      font-size: 0.9rem;
    }

    .summary-item .tag {
      margin: 0;
      padding: 1px 4px;
    }

    /* Buttons */
    .button {
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .button.secondary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 8px 20px var(--accent-glow);
    }

    .button.secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 25px var(--accent-glow);
    }

    .button.ghost {
      background: transparent;
      color: var(--ink);
      border: 1px solid var(--border);
    }

    .button.ghost:hover {
      border-color: var(--accent-2);
      box-shadow: 0 0 0 2px rgba(0, 255, 163, 0.15);
    }

    .button.small {
      padding: 6px 12px;
      font-size: 0.78rem;
      border-radius: 10px;
    }

    .button.danger {
      border-color: rgba(255, 122, 122, 0.4);
      color: #ff9c9c;
    }

    .button.danger:hover {
      border-color: rgba(255, 122, 122, 0.8);
      box-shadow: 0 0 0 2px rgba(255, 122, 122, 0.12);
    }

    /* D3 Nodes */
    .link {
      fill: none;
      stroke: rgba(255, 255, 255, 0.1);
      stroke-width: 1.5px;
    }

    .link.prev-level {
      stroke-dasharray: 4 4;
      opacity: 0.6;
    }

    .node {
      cursor: grab;
    }

    .node.dragging {
      cursor: grabbing;
    }

    .node circle {
      stroke: #000;
      stroke-width: 2.5px;
      filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.5));
    }

    .node text {
      fill: #fff;
      font-size: 12px;
      font-weight: 600;
      stroke: #000;
      stroke-width: 4px;
      paint-order: stroke;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .node .status {
      fill: var(--muted);
      font-size: 10px;
      stroke: none;
    }

    .node.prev-level circle {
      stroke-dasharray: 5 4;
      opacity: 0.75;
    }

    .node.prev-level text {
      fill: var(--muted);
    }

    .node.prev-level .status {
      opacity: 0.7;
    }

    .prev-toggle {
      cursor: pointer;
    }

    .prev-toggle circle {
      fill: rgba(0, 0, 0, 0.6);
      stroke: var(--line);
      stroke-width: 1;
    }

    .prev-toggle-label {
      fill: var(--ink);
      font-size: 11px;
      font-weight: 700;
      pointer-events: none;
    }

    .prev-toggle:hover circle {
      stroke: var(--accent-2);
      fill: rgba(0, 0, 0, 0.8);
    }

    .depth-toggle {
      cursor: pointer;
    }

    .depth-toggle circle {
      fill: rgba(0, 0, 0, 0.6);
      stroke: var(--line);
      stroke-width: 1;
    }

    .depth-toggle-label {
      fill: var(--ink);
      font-size: 10px;
      font-weight: 700;
      pointer-events: none;
    }

    .depth-toggle .is-disabled circle,
    .depth-toggle .is-disabled text {
      opacity: 0.35;
    }

    .depth-toggle .depth-btn:hover circle {
      stroke: var(--accent-2);
      fill: rgba(0, 0, 0, 0.8);
    }

    /* Rarity Icons / Colors with Transparent backgrounds */
    .rarity-common {
      --r: var(--common);
    }

    .rarity-uncommon {
      --r: var(--uncommon);
    }

    .rarity-rare {
      --r: var(--rare);
    }

    .rarity-epic {
      --r: var(--epic);
    }

    .rarity-legendary {
      --r: var(--legendary);
    }

    .chip[class*="rarity-"],
    .summary-item[class*="rarity-"] {
      border-color: var(--r) !important;
      background: color-mix(in srgb, var(--r), transparent 92%) !important;
      border: 1px solid color-mix(in srgb, var(--r), transparent 70%);
    }

    .item-list li[class*="rarity-"] {
      background: color-mix(in srgb, var(--r), transparent 88%) !important;
      border: none !important;
      margin-bottom: 2px;
    }

    .item-list li[class*="rarity-"]:hover {
      background: color-mix(in srgb, var(--r), transparent 75%) !important;
    }

    .node[class*="rarity-"] circle {
      stroke: var(--r);
    }

    #data-meta {
      display: none;
    }

    #dropzone {
      position: absolute;
      inset: 0;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      color: transparent;
      font-size: 0;
    }

    #dropzone.active {
      opacity: 1;
      background: var(--accent-tint-min);
      border: 3px dashed var(--accent);
      margin: 12px;
      border-radius: 20px;
    }

    #dropzone.active::after {
      content: attr(data-text);
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(18, 18, 20, 0.95);
      color: var(--ink);
      font-size: 0.9rem;
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }

    /* Center view button */
    #center-view {
      padding: 8px 12px;
      font-size: 1.1rem;
      min-width: auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #center-view:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Drop cursor indicator */
    .workspace.drag-over #tree {
      cursor: copy !important;
    }

    .workspace.drag-over .board {
      pointer-events: none;
    }
  </style>
</head>

<body>

  <main>
    <section class="workspace">
      <aside class="sidebar">
        <button id="toggle-sidebar" class="toggle-sidebar-btn" title="Toggle Sidebar">
          <svg viewBox="0 0 24 24">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <div class="sidebar-inner">
          <div class="sidebar-header">
            <h2 id="categories-title">Categories</h2>
            <button id="toggle-lang" class="button ghost">ES</button>
          </div>
          <div class="filters">
            <input id="search" type="search" placeholder="Search materials...">
          </div>
          <button id="open-guide" class="button ghost guide-btn">Open guide</button>
          <div id="category-list" class="category-list"></div>
        </div>
      </aside>

      <div class="workspace-canvas">
        <div id="dropzone">Drop to add to tree</div>
        <div class="board-switcher" id="board-switcher">
          <button id="board-craft" class="board-btn active" data-board="craft">Crafting</button>
          <button id="board-uses" class="board-btn" data-board="uses">Uses</button>
          <button id="board-recycle" class="board-btn" data-board="recycle">Recycling</button>
        </div>
        <!-- Banner for shared boards -->
        <div id="share-banner" class="share-banner is-hidden">
          <span id="share-banner-text">Board compartida</span>
          <button id="share-save-btn" class="button secondary small">Guardar copia</button>
          <button id="share-dismiss-btn" class="share-dismiss">√ó</button>
        </div>
        <svg id="tree"></svg>

        <!-- Unified Control Panel - Bottom Left -->
        <div class="control-panel" id="control-panel">
          <div class="control-content">
            <div class="control-header">
              <div class="control-title">
                <span>üìÅ</span>
                <span id="boards-title">Mis Boards</span>
              </div>
              <div class="control-actions">
                <button id="save-board-btn" class="control-btn" title="Guardar board actual">üíæ Guardar</button>
                <button id="new-board-btn" class="control-btn primary">+ Nueva</button>
              </div>
            </div>

            <div class="boards-section">
              <div class="boards-section-title">Board actual</div>
              <div class="board-card active" id="current-board-card">
                <div class="board-card-icon">üìã</div>
                <div class="board-card-info">
                  <button class="board-card-name" id="current-board-name">Sin guardar</button>
                  <div class="board-card-meta">Sesi√≥n activa</div>
                </div>
                <div class="board-card-actions" style="opacity: 1;">
                  <button class="board-action-btn share-trigger" id="share-board-btn" title="Compartir">üîó</button>
                  <div class="share-dropdown" id="share-dropdown">
                    <button class="share-option" data-action="copy">
                      <span class="share-icon">üìã</span>
                      <span>Copiar enlace</span>
                    </button>
                    <button class="share-option" data-action="whatsapp">
                      <span class="share-icon">üí¨</span>
                      <span>WhatsApp</span>
                    </button>
                    <button class="share-option" data-action="twitter">
                      <span class="share-icon">üê¶</span>
                      <span>Twitter / X</span>
                    </button>
                    <button class="share-option" data-action="telegram">
                      <span class="share-icon">‚úàÔ∏è</span>
                      <span>Telegram</span>
                    </button>
                  </div>
                </div>
              </div>

              <div class="boards-section-title" id="saved-boards-title">Boards guardadas</div>
              <div id="boards-list" class="boards-list"></div>
              <div id="boards-empty" class="boards-empty">
                <div class="boards-empty-icon">üìÇ</div>
                <div class="boards-empty-text">No tienes boards guardadas</div>
              </div>
            </div>
          </div>

          <button class="control-trigger" id="control-trigger" title="Gestionar boards">
            <span class="icon-open">üìÅ</span>
            <span class="icon-close">‚úï</span>
          </button>
        </div>

        <!-- Selection Bar - Fixed Center Bottom -->
        <div class="selection-bar" id="selection-bar">
          <div id="selected-chips" class="selected-chips"></div>
          <div class="selection-actions">
            <button id="center-view" class="selection-btn ghost" title="Centrar vista">‚åñ</button>
            <button id="clear-selection" class="selection-btn danger">Limpiar</button>
          </div>
        </div>

        <aside class="summary-panel" id="summary-panel">
          <div id="summary-resizer" class="summary-resizer"></div>
          <button id="toggle-summary" class="toggle-summary-btn" title="Toggle Summary">
            <svg viewBox="0 0 24 24">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
          <div class="summary-scroll">
            <div class="summary-header">
              <h3 id="summary-title">Base Materials</h3>
              <button id="sort-summary" class="sort-btn" title="Toggle Sort (Name/Rarity)">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path d="M15 18l-3 3-3-3" />
                  <path d="M12 3v18" />
                  <path d="M9 6l3-3 3 3" />
                </svg>
                <span id="sort-label">Order</span>
              </button>
            </div>
            <div id="summary-empty" class="summary-empty">Select items to see requirements</div>
            <ul id="summary-list" class="summary-list"></ul>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <div id="guide-modal" class="guide-modal" aria-hidden="true">
    <div class="guide-backdrop" id="guide-backdrop"></div>
    <div class="guide-dialog" role="dialog" aria-modal="true" aria-labelledby="guide-title">
      <div class="guide-header">
        <h2 id="guide-title">ARC Raiders Inventory Management Guide</h2>
        <button id="close-guide" class="guide-close" type="button">Close</button>
      </div>
      <div class="guide-content">
        <div class="lang lang-en">
          <h3>What this tool is</h3>
          <p>
            This is an ARC Raiders inventory management tool designed to visualize crafting,
            item uses, and recycling. It helps you plan materials, upgrades, and routes by
            showing dependencies in a clear tree.
          </p>
          <h3>Crafting board</h3>
          <ol>
            <li>Switch to Crafting at the top.</li>
            <li>Search or browse items in the left list and drag one to the board.</li>
            <li>Use +/- on a weapon to show or hide previous levels.</li>
            <li>Check the summary on the right for required materials.</li>
          </ol>
          <h3>Uses board</h3>
          <ol>
            <li>Switch to Uses to see what an item can craft.</li>
            <li>Drop a material (e.g., Oil) and expand layers with + to see deeper uses.</li>
            <li>Great for planning crafting chains and inventory management.</li>
          </ol>
          <h3>Recycling board</h3>
          <ol>
            <li>Switch to Recycling.</li>
            <li>Drop a target material (e.g., Processor) to see items that recycle into it.</li>
            <li>Use this to decide what to keep or recycle during runs.</li>
          </ol>

        </div>
        <div class="lang lang-es">
          <h3>Que es esta herramienta</h3>
          <p>
            Esta es una herramienta de gestion de inventario para ARC Raiders. Visualiza crafteo,
            usos de items y reciclaje para planificar materiales, mejoras y rutas con un arbol claro.
          </p>
          <h3>Pizarra de crafteo</h3>
          <ol>
            <li>Cambia a Crafteo en el selector superior.</li>
            <li>Busca o navega items en la lista izquierda y arrastra uno a la pizarra.</li>
            <li>Usa +/- en el arma para mostrar u ocultar niveles anteriores.</li>
            <li>Revisa el resumen a la derecha con materiales requeridos.</li>
          </ol>
          <h3>Pizarra de usos</h3>
          <ol>
            <li>Cambia a Usos para ver que se puede fabricar con un item.</li>
            <li>Arrastra un material (por ejemplo, Aceite) y expande capas con +.</li>
            <li>Ideal para planificar cadenas de crafteo y gestion de inventario.</li>
          </ol>
          <h3>Pizarra de reciclaje</h3>
          <ol>
            <li>Cambia a Reciclaje.</li>
            <li>Arrastra un material objetivo (por ejemplo, Procesador) para ver que lo recicla.</li>
            <li>Te ayuda a decidir que guardar o reciclar durante las partidas.</li>
          </ol>

        </div>
      </div>
    </div>
  </div>

  <div id="board-modal" class="board-modal" aria-hidden="true">
    <div class="board-backdrop" id="board-backdrop"></div>
    <div class="board-dialog" role="dialog" aria-modal="true" aria-labelledby="board-modal-title">
      <div class="modal-header">
        <h2 id="board-modal-title">Nueva board</h2>
        <button id="board-modal-close" class="guide-close" type="button">Cerrar</button>
      </div>
      <form id="board-form" class="modal-body">
        <label id="board-name-label" for="board-name-input">Nombre de la board</label>
        <input id="board-name-input" name="board-name-input" type="text" maxlength="48" required>
        <div id="board-error" class="modal-error is-hidden"></div>
        <div class="modal-actions">
          <button id="board-cancel" type="button" class="button ghost small">Cancelar</button>
          <button id="board-save" type="submit" class="button secondary">Guardar</button>
        </div>
      </form>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <script src="data.js"></script>
  <script>
    const DATA = window.ARCDATA;
    const imageMap = DATA.images || {};

    const ui = {
      search: document.getElementById("search"),
      categoryList: document.getElementById("category-list"),
      dropzone: document.getElementById("dropzone"),
      tree: document.getElementById("tree"),
      dataMeta: document.getElementById("data-meta"),
      selectedChips: document.getElementById("selected-chips"),
      clearSelection: document.getElementById("clear-selection"),
      summaryList: document.getElementById("summary-list"),
      summaryEmpty: document.getElementById("summary-empty"),
      toggleSidebar: document.getElementById("toggle-sidebar"),
      toggleSummary: document.getElementById("toggle-summary"),
      summaryPanel: document.getElementById("summary-panel"),
      summaryResizer: document.getElementById("summary-resizer"),
      sortSummary: document.getElementById("sort-summary"),
      sortLabel: document.getElementById("sort-label"),
      categoriesTitle: document.getElementById("categories-title"),
      summaryTitle: document.getElementById("summary-title"),
      centerView: document.getElementById("center-view"),
      boardCraft: document.getElementById("board-craft"),
      boardUses: document.getElementById("board-uses"),
      boardRecycle: document.getElementById("board-recycle"),
      openGuide: document.getElementById("open-guide"),
      guideModal: document.getElementById("guide-modal"),
      guideBackdrop: document.getElementById("guide-backdrop"),
      closeGuide: document.getElementById("close-guide"),
      guideTitle: document.getElementById("guide-title"),
      langToggle: document.getElementById("toggle-lang"),
      // Save/Share buttons
      saveBoardBtn: document.getElementById("save-board-btn"),
      shareBoardBtn: document.getElementById("share-board-btn"),
      // Share banner
      shareBanner: document.getElementById("share-banner"),
      shareBannerText: document.getElementById("share-banner-text"),
      shareSaveBtn: document.getElementById("share-save-btn"),
      shareDismissBtn: document.getElementById("share-dismiss-btn"),
      // Boards drawer
      boardsDrawer: document.getElementById("boards-drawer"),
      boardsHandle: document.getElementById("boards-handle"),
      boardsHandleTitle: document.getElementById("boards-handle-title"),
      currentBoardName: document.getElementById("current-board-name"),
      boardsList: document.getElementById("boards-list"),
      boardsTitle: document.getElementById("boards-title"),
      boardsEmpty: document.getElementById("boards-empty"),
      newBoardBtn: document.getElementById("new-board-btn"),
      // Board modal
      boardModal: document.getElementById("board-modal"),
      boardBackdrop: document.getElementById("board-backdrop"),
      boardForm: document.getElementById("board-form"),
      boardNameInput: document.getElementById("board-name-input"),
      boardError: document.getElementById("board-error"),
      boardModalTitle: document.getElementById("board-modal-title"),
      boardNameLabel: document.getElementById("board-name-label"),
      boardSave: document.getElementById("board-save"),
      boardCancel: document.getElementById("board-cancel"),
      boardModalClose: document.getElementById("board-modal-close"),
      // Control Panel
      controlPanel: document.getElementById("control-panel"),
      controlTrigger: document.getElementById("control-trigger"),
      shareDropdown: document.getElementById("share-dropdown"),
      selectionBar: document.getElementById("selection-bar")
    };

    let sortMode = "name"; // 'name' or 'rarity'

    const items = DATA.items || [];
    const itemsMap = new Map(items.map(item => [item.name, item]));
    const categories = DATA.categories || { order: [], labels: {}, members: {} };
    const categoryLabels = {
      en: {
        "Weapons": "Weapons",
        "Attachments": "Attachments",
        "Augments": "Augments",
        "Shields": "Shields",
        "Healing": "Healing",
        "Quick Use": "Quick Use",
        "Grenades": "Grenades",
        "Traps": "Traps"
      },
      es: categories.labels || {}
    };
    const state = {
      lang: "en",
      board: "craft",
      prevLevels: new Map(),
      usesDepth: new Map()
    };
    const selections = {
      craft: new Map(),
      uses: new Map(),
      recycle: new Map()
    };
    const treePositions = {
      craft: new Map(),
      uses: new Map(),
      recycle: new Map()
    };
    const zoomTransforms = {
      craft: d3.zoomIdentity,
      uses: d3.zoomIdentity,
      recycle: d3.zoomIdentity
    };

    const STORAGE_KEYS = {
      currentState: "arc_raiders_craft_state",
      boards: "arc_raiders_boards_v2",
      currentBoardId: "arc_raiders_current_board"
    };

    // Track if we're viewing a shared board (not saved locally)
    let isViewingSharedBoard = false;
    let sharedBoardData = null;
    let currentBoardId = null;

    let boardModalMode = "new";
    let boardModalTarget = null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BOARDS STORAGE (simplified, no user)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function loadBoardsStore() {
      try {
        const saved = localStorage.getItem(STORAGE_KEYS.boards);
        if (!saved) {
          return { boards: [] };
        }
        return JSON.parse(saved);
      } catch (e) {
        console.error("Error loading boards:", e);
        return { boards: [] };
      }
    }

    function saveBoardsStore(store) {
      try {
        localStorage.setItem(STORAGE_KEYS.boards, JSON.stringify(store));
      } catch (e) {
        console.error("Error saving boards:", e);
      }
    }

    function loadCurrentBoardId() {
      return localStorage.getItem(STORAGE_KEYS.currentBoardId) || null;
    }

    function saveCurrentBoardId(id) {
      if (id) {
        localStorage.setItem(STORAGE_KEYS.currentBoardId, id);
      } else {
        localStorage.removeItem(STORAGE_KEYS.currentBoardId);
      }
    }

    function generateBoardId() {
      return `board_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    function getDefaultBoardName(store) {
      const count = store.boards.length + 1;
      return `Board ${count}`;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // URL SHARING (compress with lz-string)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function compressBoardData(data) {
      try {
        const json = JSON.stringify(data);
        return LZString.compressToEncodedURIComponent(json);
      } catch (e) {
        console.error("Error compressing board data:", e);
        return null;
      }
    }

    function decompressBoardData(compressed) {
      try {
        const json = LZString.decompressFromEncodedURIComponent(compressed);
        if (!json) return null;
        return JSON.parse(json);
      } catch (e) {
        console.error("Error decompressing board data:", e);
        return null;
      }
    }

    function generateShareURL() {
      const data = serializeAppState();
      const compressed = compressBoardData(data);
      if (!compressed) return null;

      const url = new URL(window.location.href);
      url.hash = `board=${compressed}`;
      return url.toString();
    }

    function parseShareURL() {
      const hash = window.location.hash;
      if (!hash || !hash.startsWith("#board=")) return null;

      const compressed = hash.substring(7); // Remove "#board="
      return decompressBoardData(compressed);
    }

    function clearShareURL() {
      if (window.location.hash.startsWith("#board=")) {
        history.replaceState(null, "", window.location.pathname + window.location.search);
      }
    }

    function createBoard(store, name, data) {
      const id = generateBoardId();
      const board = {
        id,
        name,
        updatedAt: new Date().toISOString(),
        data
      };
      store.boards.unshift(board);
      return board;
    }

    function serializeAppState() {
      return {
        selections: {
          craft: Array.from(selections.craft.entries()),
          uses: Array.from(selections.uses.entries()),
          recycle: Array.from(selections.recycle.entries())
        },
        treePositions: {
          craft: Array.from(treePositions.craft.entries()),
          uses: Array.from(treePositions.uses.entries()),
          recycle: Array.from(treePositions.recycle.entries())
        },
        zoomTransforms: {
          craft: { x: zoomTransforms.craft.x, y: zoomTransforms.craft.y, k: zoomTransforms.craft.k },
          uses: { x: zoomTransforms.uses.x, y: zoomTransforms.uses.y, k: zoomTransforms.uses.k },
          recycle: { x: zoomTransforms.recycle.x, y: zoomTransforms.recycle.y, k: zoomTransforms.recycle.k }
        },
        state: { lang: state.lang, board: state.board },
        prevLevels: Array.from(state.prevLevels.entries()),
        usesDepth: Array.from(state.usesDepth.entries()),
        sortMode: sortMode
      };
    }

    function buildEmptyState() {
      return {
        selections: { craft: [], uses: [], recycle: [] },
        treePositions: { craft: [], uses: [], recycle: [] },
        zoomTransforms: {
          craft: { x: 0, y: 0, k: 1 },
          uses: { x: 0, y: 0, k: 1 },
          recycle: { x: 0, y: 0, k: 1 }
        },
        state: { lang: state.lang, board: "craft" },
        prevLevels: [],
        usesDepth: [],
        sortMode: sortMode
      };
    }

    function applyAppState(data) {
      if (!data) return;

      state.board = "craft";
      state.prevLevels = new Map();
      state.usesDepth = new Map();
      selections.craft = new Map();
      selections.uses = new Map();
      selections.recycle = new Map();
      treePositions.craft = new Map();
      treePositions.uses = new Map();
      treePositions.recycle = new Map();
      zoomTransforms.craft = d3.zoomIdentity;
      zoomTransforms.uses = d3.zoomIdentity;
      zoomTransforms.recycle = d3.zoomIdentity;
      sortMode = "name";

      if (data.state && data.state.lang) state.lang = data.state.lang;
      if (data.state && data.state.board && ["craft", "uses", "recycle"].includes(data.state.board)) {
        state.board = data.state.board;
      }
      if (data.sortMode) sortMode = data.sortMode;
      if (Array.isArray(data.prevLevels)) {
        state.prevLevels = new Map(data.prevLevels);
      }
      if (Array.isArray(data.usesDepth)) {
        state.usesDepth = new Map(data.usesDepth);
      }

      if (data.selections && data.selections.craft) {
        selections.craft = new Map(data.selections.craft);
      }
      if (data.selections && data.selections.uses) {
        selections.uses = new Map(data.selections.uses);
      }
      if (data.selections && data.selections.recycle) {
        selections.recycle = new Map(data.selections.recycle);
      }
      if (Array.isArray(data.selection)) {
        selections.craft = new Map(data.selection);
      }

      if (data.treePositions && data.treePositions.craft) {
        treePositions.craft = new Map(data.treePositions.craft);
      }
      if (data.treePositions && data.treePositions.uses) {
        treePositions.uses = new Map(data.treePositions.uses);
      }
      if (data.treePositions && data.treePositions.recycle) {
        treePositions.recycle = new Map(data.treePositions.recycle);
      }
      if (Array.isArray(data.treePositions)) {
        treePositions.craft = new Map(data.treePositions);
      }

      if (data.zoomTransforms && data.zoomTransforms.craft) {
        zoomTransforms.craft = d3.zoomIdentity
          .translate(data.zoomTransforms.craft.x, data.zoomTransforms.craft.y)
          .scale(data.zoomTransforms.craft.k);
      }
      if (data.zoomTransforms && data.zoomTransforms.uses) {
        zoomTransforms.uses = d3.zoomIdentity
          .translate(data.zoomTransforms.uses.x, data.zoomTransforms.uses.y)
          .scale(data.zoomTransforms.uses.k);
      }
      if (data.zoomTransforms && data.zoomTransforms.recycle) {
        zoomTransforms.recycle = d3.zoomIdentity
          .translate(data.zoomTransforms.recycle.x, data.zoomTransforms.recycle.y)
          .scale(data.zoomTransforms.recycle.k);
      }
      if (data.zoomTransform) {
        zoomTransforms.craft = d3.zoomIdentity
          .translate(data.zoomTransform.x, data.zoomTransform.y)
          .scale(data.zoomTransform.k);
      }
    }

    function readCurrentState() {
      try {
        const saved = localStorage.getItem(STORAGE_KEYS.currentState);
        if (!saved) return null;
        return JSON.parse(saved);
      } catch (e) {
        console.error("Error loading saved state:", e);
        return null;
      }
    }

    function saveCurrentState() {
      const data = serializeAppState();
      localStorage.setItem(STORAGE_KEYS.currentState, JSON.stringify(data));

      // Also update the board if we have one selected
      if (currentBoardId && !isViewingSharedBoard) {
        const store = loadBoardsStore();
        const board = store.boards.find(b => b.id === currentBoardId);
        if (board) {
          board.data = data;
          board.updatedAt = new Date().toISOString();
          saveBoardsStore(store);
        }
      }
    }

    function loadCurrentState() {
      const data = readCurrentState();
      if (!data) return false;
      applyAppState(data);
      return true;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BOARD OPERATIONS (simplified)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function saveAsNewBoard(name) {
      const store = loadBoardsStore();
      const data = serializeAppState();
      const board = createBoard(store, name, data);
      saveBoardsStore(store);

      currentBoardId = board.id;
      saveCurrentBoardId(board.id);
      isViewingSharedBoard = false;
      sharedBoardData = null;

      updateBoardsUI();
      hideShareBanner();
      return board;
    }

    function switchToBoard(boardId) {
      if (currentBoardId === boardId && !isViewingSharedBoard) {
        if (ui.controlPanel) ui.controlPanel.classList.remove("is-open");
        return;
      }

      // Save current state if we have an active board
      if (currentBoardId && !isViewingSharedBoard) {
        saveCurrentState();
      }

      const store = loadBoardsStore();
      const board = store.boards.find(b => b.id === boardId);
      if (!board) return;

      currentBoardId = boardId;
      saveCurrentBoardId(boardId);
      isViewingSharedBoard = false;
      sharedBoardData = null;

      applyAppState(board.data);
      applyLanguage();
      updateBoardsUI();
      hideShareBanner();
      if (ui.controlPanel) ui.controlPanel.classList.remove("is-open");
    }

    function deleteBoard(boardId) {
      const store = loadBoardsStore();
      const idx = store.boards.findIndex(b => b.id === boardId);
      if (idx === -1) return;

      store.boards.splice(idx, 1);
      saveBoardsStore(store);

      // If we deleted the current board, switch to another or clear
      if (currentBoardId === boardId) {
        if (store.boards.length > 0) {
          switchToBoard(store.boards[0].id);
        } else {
          currentBoardId = null;
          saveCurrentBoardId(null);
          applyAppState(buildEmptyState());
          applyLanguage();
        }
      }

      updateBoardsUI();
    }

    function renameBoard(boardId, newName) {
      const store = loadBoardsStore();
      const board = store.boards.find(b => b.id === boardId);
      if (!board) return;

      board.name = newName;
      board.updatedAt = new Date().toISOString();
      saveBoardsStore(store);
      updateBoardsUI();
    }

    const uiStrings = {
      en: {
        categories: "Categories",
        searchPlaceholder: "Search materials...",
        dropzoneCraft: "Drop to add to tree",
        dropzoneUses: "Drop to see what it crafts",
        dropzoneRecycle: "Drop to see what recycles into it",
        clearSelection: "Clear Selection",
        summaryTitleCraft: "All Items",
        summaryTitleUses: "Can Be Crafted",
        summaryTitleRecycle: "Recycled Into",
        summaryEmptyCraft: "Select items to see requirements",
        summaryEmptyUses: "Select items to see what they craft",
        summaryEmptyRecycle: "Select items to see what recycles into them",
        noFilterItems: "No items matching this filter.",
        others: "Others",
        craftTag: "CRAFT",
        lootTag: "LOOT",
        recycleTag: "RECYCLE",
        craftable: "craftable",
        lootOnly: "loot-only",
        noMaterials: "No materials required.",
        noUses: "No items use this.",
        noRecycle: "No items recycle into this.",
        noBaseLoot: "No base loot-only items.",
        toggleSidebar: "Toggle Sidebar",
        toggleSummary: "Toggle Summary",
        boardCraft: "Crafting",
        boardUses: "Uses",
        boardRecycle: "Recycling",
        usesDepthMore: "More layers",
        usesDepthLess: "Fewer layers",
        openGuide: "Open guide",
        closeGuide: "Close",
        guideTitle: "ARC Raiders Inventory Management Guide",
        prevLevelsShow: "Show previous levels",
        prevLevelsHide: "Hide previous levels",
        langLabel: "EN",
        title: "ARC Raiders Crafting, Uses & Recycling | Inventory Planner",
        centerView: "Center view",
        // Save/Share
        saveBoard: "üíæ Save",
        shareBoard: "üîó Share",
        shareCopied: "Copied!",
        shareError: "Error generating share URL",
        sharePrompt: "Copy this URL:",
        sharedBoard: "Shared board",
        sharedBannerText: "Shared board",
        saveCopy: "Save copy",
        saved: "Saved!",
        unsavedBoard: "Unsaved",
        // Boards
        boardDrawerTitle: "My Boards",
        boardDefaultName: "My board",
        boardNew: "+ New",
        boardDelete: "Delete",
        boardDeleteConfirm: "Delete this board?",
        boardEmpty: "No saved boards",
        boardNewTitle: "Save board",
        boardRenameTitle: "Rename board",
        boardNameLabel: "Board name",
        boardSave: "Save",
        boardCancel: "Cancel",
        modalClose: "Close"
      },
      es: {
        categories: "Categorias",
        searchPlaceholder: "Buscar materiales...",
        dropzoneCraft: "Suelta para agregar al arbol",
        dropzoneUses: "Suelta para ver en que se usa",
        dropzoneRecycle: "Suelta para ver que recicla en el",
        clearSelection: "Limpiar seleccion",
        summaryTitleCraft: "Todos los items",
        summaryTitleUses: "Se puede craftear",
        summaryTitleRecycle: "Reciclado en",
        summaryEmptyCraft: "Selecciona items para ver requisitos",
        summaryEmptyUses: "Selecciona items para ver usos",
        summaryEmptyRecycle: "Selecciona items para ver que recicla en ellos",
        noFilterItems: "No hay items con este filtro.",
        others: "Otros",
        craftTag: "FAB",
        lootTag: "BOTIN",
        recycleTag: "RECICLA",
        craftable: "crafteable",
        lootOnly: "solo loot",
        noMaterials: "No hay materiales requeridos.",
        noUses: "Ningun item lo usa.",
        noRecycle: "Ningun item recicla en esto.",
        noBaseLoot: "No hay items base solo loot.",
        toggleSidebar: "Mostrar/Ocultar menu",
        toggleSummary: "Mostrar/Ocultar resumen",
        boardCraft: "Crafteo",
        boardUses: "Usos",
        boardRecycle: "Reciclaje",
        usesDepthMore: "Mas capas",
        usesDepthLess: "Menos capas",
        openGuide: "Abrir guia",
        closeGuide: "Cerrar",
        guideTitle: "Guia de gestion de inventario ARC Raiders",
        prevLevelsShow: "Mostrar niveles anteriores",
        prevLevelsHide: "Ocultar niveles anteriores",
        langLabel: "ES",
        title: "ARC Raiders Arboles de crafteo, usos y reciclaje | Inventario",
        centerView: "Centrar vista",
        // Save/Share
        saveBoard: "üíæ Guardar",
        shareBoard: "üîó Compartir",
        shareCopied: "¬°Copiado!",
        shareError: "Error generando URL",
        sharePrompt: "Copia esta URL:",
        sharedBoard: "Board compartida",
        sharedBannerText: "Board compartida",
        saveCopy: "Guardar copia",
        saved: "¬°Guardado!",
        unsavedBoard: "Sin guardar",
        // Boards
        boardDrawerTitle: "Mis Boards",
        boardDefaultName: "Mi board",
        boardNew: "+ Nueva",
        boardDelete: "Eliminar",
        boardDeleteConfirm: "¬øEliminar esta board?",
        boardEmpty: "Sin boards guardadas",
        boardNewTitle: "Guardar board",
        boardRenameTitle: "Renombrar board",
        boardNameLabel: "Nombre de la board",
        boardSave: "Guardar",
        boardCancel: "Cancelar",
        modalClose: "Cerrar"
      }
    };

    function t(key) {
      return uiStrings[state.lang][key] || key;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UI UPDATES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function updateBoardsUI() {
      const store = loadBoardsStore();

      // Update handle text
      if (isViewingSharedBoard) {
        ui.currentBoardName.textContent = t("sharedBoard") || "Board compartida";
      } else if (currentBoardId) {
        const board = store.boards.find(b => b.id === currentBoardId);
        ui.currentBoardName.textContent = board ? board.name : t("unsavedBoard");
      } else {
        ui.currentBoardName.textContent = t("unsavedBoard");
      }

      // Build list
      ui.boardsList.innerHTML = "";
      if (!store.boards.length) {
        ui.boardsEmpty.classList.remove("is-hidden");
        return;
      }

      ui.boardsEmpty.classList.add("is-hidden");
      store.boards.forEach(board => {
        const row = document.createElement("div");
        row.className = `board-row${board.id === currentBoardId && !isViewingSharedBoard ? " active" : ""}`;

        const button = document.createElement("button");
        button.type = "button";
        button.className = "board-item";
        button.textContent = board.name;
        button.addEventListener("click", () => switchToBoard(board.id));

        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "board-delete";
        deleteBtn.textContent = "√ó";
        deleteBtn.title = t("boardDelete");
        deleteBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          if (confirm(t("boardDeleteConfirm"))) {
            deleteBoard(board.id);
          }
        });

        row.appendChild(button);
        row.appendChild(deleteBtn);
        ui.boardsList.appendChild(row);
      });
    }

    function showShareBanner() {
      ui.shareBanner.classList.remove("is-hidden");
    }

    function hideShareBanner() {
      ui.shareBanner.classList.add("is-hidden");
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INITIALIZATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function loadInitialState() {
      // Check for shared board in URL first
      const sharedData = parseShareURL();
      if (sharedData) {
        isViewingSharedBoard = true;
        sharedBoardData = sharedData;
        applyAppState(sharedData);
        showShareBanner();
        clearShareURL();
        return;
      }

      // Try to load saved board
      currentBoardId = loadCurrentBoardId();
      if (currentBoardId) {
        const store = loadBoardsStore();
        const board = store.boards.find(b => b.id === currentBoardId);
        if (board) {
          applyAppState(board.data);
          return;
        }
        // Board was deleted, clear the reference
        currentBoardId = null;
        saveCurrentBoardId(null);
      }

      // Load current state from localStorage or start fresh
      if (!loadCurrentState()) {
        applyAppState(buildEmptyState());
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SHARE ACTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function handleShare() {
      const url = generateShareURL();
      if (!url) {
        alert(t("shareError") || "Error generating share URL");
        return;
      }

      // Try to copy to clipboard
      navigator.clipboard.writeText(url).then(() => {
        // Show temporary feedback
        const originalText = ui.shareBoardBtn.textContent;
        ui.shareBoardBtn.textContent = "‚úì";
        setTimeout(() => {
          ui.shareBoardBtn.textContent = originalText;
        }, 2000);
      }).catch(() => {
        // Fallback: show URL in prompt
        prompt(t("sharePrompt") || "Copia esta URL:", url);
      });
    }

    function handleShareAction(action) {
      const url = generateShareURL();
      if (!url) {
        alert(t("shareError") || "Error generating share URL");
        return;
      }

      const text = "Check out my ARC Raiders board!";

      switch (action) {
        case 'copy':
          navigator.clipboard.writeText(url).then(() => {
            alert(t("shareCopied") || "¬°Enlace copiado!");
          }).catch(() => {
            prompt(t("sharePrompt") || "Copia esta URL:", url);
          });
          break;
        case 'whatsapp':
          window.open(`https://wa.me/?text=${encodeURIComponent(text + " " + url)}`, '_blank');
          break;
        case 'twitter':
          window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
          break;
        case 'telegram':
          window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`, '_blank');
          break;
      }
    }

    function handleSave() {
      if (isViewingSharedBoard || !currentBoardId) {
        // Need to create new board - open modal
        openBoardModal("new");
      } else {
        // Update existing board silently
        saveCurrentState();
        // Show feedback
        const originalText = ui.saveBoardBtn.textContent;
        ui.saveBoardBtn.textContent = "‚úì " + (t("saved") || "Guardado!");
        setTimeout(() => {
          ui.saveBoardBtn.textContent = originalText;
        }, 1500);
      }
    }

    function handleSaveSharedBoard() {
      openBoardModal("new");
    }

    function openBoardModal(mode, targetId = null) {
      boardModalMode = mode;
      boardModalTarget = targetId;
      ui.boardError.textContent = "";
      ui.boardError.classList.add("is-hidden");
      ui.boardModalTitle.textContent = mode === "rename" ? t("boardRenameTitle") : t("boardNewTitle");

      const store = loadBoardsStore();
      if (mode === "rename") {
        const board = store.boards.find(b => b.id === targetId);
        ui.boardNameInput.value = board ? board.name : "";
      } else {
        ui.boardNameInput.value = getDefaultBoardName(store);
      }

      ui.boardModal.classList.add("open");
      ui.boardModal.setAttribute("aria-hidden", "false");
      setTimeout(() => ui.boardNameInput.focus(), 50);
    }

    function closeBoardModal() {
      ui.boardModal.classList.remove("open");
      ui.boardModal.setAttribute("aria-hidden", "true");
    }

    function handleBoardFormSubmit(event) {
      event.preventDefault();
      const name = String(ui.boardNameInput.value || "").trim();
      if (!name) {
        ui.boardNameInput.focus();
        return;
      }
      if (boardModalMode === "rename") {
        renameBoard(boardModalTarget, name);
      } else {
        // Save current state as new board
        saveAsNewBoard(name);
      }
      closeBoardModal();
    }

    function getActiveSelection() {
      if (state.board === "uses") return selections.uses;
      if (state.board === "recycle") return selections.recycle;
      return selections.craft;
    }

    function getActivePositions() {
      if (state.board === "uses") return treePositions.uses;
      if (state.board === "recycle") return treePositions.recycle;
      return treePositions.craft;
    }

    function getActiveZoom() {
      return zoomTransforms[state.board] || d3.zoomIdentity;
    }

    function setActiveZoom(transform) {
      zoomTransforms[state.board] = transform;
    }

    function getItemLabel(item) {
      if (!item) return "";
      if (state.lang === "es" && item.name_es) return item.name_es;
      return item.name;
    }

    function getItemLabelByName(name) {
      const item = itemsMap.get(name);
      if (!item) return name;
      return getItemLabel(item);
    }

    function normalizeString(str) {
      if (!str) return "";
      return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    function matchesQuery(item, query) {
      if (!query) return true;
      const q = normalizeString(query);
      const candidates = [item.name, item.name_es].filter(Boolean).map(name => normalizeString(name));
      return candidates.some(name => name.includes(q));
    }

    function getBaseName(name) {
      return name.replace(/\s+(?:L\d+|I{1,3}|IV|V|Mk\.\s*\d+.*)$/i, "").trim();
    }

    function getItemImage(name) {
      if (imageMap[name]) return imageMap[name];
      const baseName = getBaseName(name);
      return imageMap[baseName] || null;
    }

    function normalizeRarity(rarity) {
      if (!rarity) return "";
      const lower = String(rarity).toLowerCase();
      if (lower.includes("legend")) return "legendary";
      if (lower.includes("epic")) return "epic";
      if (lower.includes("rare")) return "rare";
      if (lower.includes("uncommon")) return "uncommon";
      if (lower.includes("common")) return "common";
      return "";
    }

    function getPreviousLevelName(name) {
      const matchL = name.match(/^(.*) L([234])$/);
      if (matchL) {
        const base = matchL[1].trim();
        const level = parseInt(matchL[2], 10);
        if (Number.isNaN(level) || level <= 1) return null;
        if (level === 2) {
          const levelOne = `${base} I`;
          if (itemsMap.has(levelOne)) return levelOne;
          return base;
        }
        return `${base} L${level - 1}`;
      }

      const matchRoman = name.match(/^(.*) (II|III|IV)$/);
      if (matchRoman) {
        const base = matchRoman[1].trim();
        const roman = matchRoman[2];
        const prevMap = { II: "I", III: "II", IV: "III" };
        const prevRoman = prevMap[roman];
        if (!prevRoman) return null;
        const prevName = `${base} ${prevRoman}`;
        if (itemsMap.has(prevName)) return prevName;
        if (roman === "II" && itemsMap.has(base)) return base;
        return prevName;
      }

      const matchMk = name.match(/^(.*) Mk\\.?\\s*([234])$/i);
      if (matchMk) {
        const base = matchMk[1].trim();
        const level = parseInt(matchMk[2], 10);
        if (Number.isNaN(level) || level <= 1) return null;
        const prev = level - 1;
        const prevName = `${base} Mk. ${prev}`;
        if (itemsMap.has(prevName)) return prevName;
        return prevName;
      }

      return null;
    }

    function shouldShowPrevLevels(name) {
      if (!state.prevLevels.has(name)) return true;
      return state.prevLevels.get(name);
    }

    function togglePrevLevels(name) {
      const next = !shouldShowPrevLevels(name);
      state.prevLevels.set(name, next);
      saveCurrentState();
      renderAll();
    }

    function getUsesDepth(name) {
      if (!state.usesDepth.has(name)) return 1;
      return state.usesDepth.get(name);
    }

    function adjustUsesDepth(name, delta) {
      const next = Math.max(1, getUsesDepth(name) + delta);
      state.usesDepth.set(name, next);
      saveCurrentState();
      renderAll();
    }

    function getCombinedRecipe(item, options = {}) {
      const includePrevLevels = options.includePrevLevels ?? shouldShowPrevLevels(item.name);
      const recipe = Array.isArray(item.recipe) ? item.recipe : [];
      const baseRecipe = recipe.map(ing => ({ item: ing.item, qty: ing.qty, isPrevLevel: false }));
      const prev = getPreviousLevelName(item.name);
      if (!prev) return baseRecipe;

      if (includePrevLevels) {
        return baseRecipe.concat([{ item: prev, qty: 1, isPrevLevel: true }]);
      }
      return baseRecipe;
    }

    function buildUsesMap() {
      const map = new Map();
      items.forEach(item => {
        const recipe = getCombinedRecipe(item, { includePrevLevels: true });
        recipe.forEach(ing => {
          if (!map.has(ing.item)) map.set(ing.item, []);
          map.get(ing.item).push({ name: item.name, qty: ing.qty });
        });
      });
      return map;
    }

    let usesMap = buildUsesMap();

    function buildRecycleMap() {
      const map = new Map();
      items.forEach(item => {
        const recycles = item.recyclesInto || {};
        Object.entries(recycles).forEach(([target, qty]) => {
          if (!map.has(target)) map.set(target, []);
          map.get(target).push({ name: item.name, qty });
        });
      });
      return map;
    }

    let recycleMap = buildRecycleMap();

    function buildTreeData(name, qty = 1, visited = new Set(), isPrevLevel = false) {
      const item = itemsMap.get(name) || { name, craftable: false, recipe: [], rarity: null };
      const recipe = getCombinedRecipe(item);
      const craftable = !!(recipe.length);
      const hasPrevLevel = !!getPreviousLevelName(item.name);
      const node = {
        name: item.name,
        qty,
        craftable,
        station: item.station || "",
        recipe,
        image: getItemImage(item.name),
        rarity: item.rarity || null,
        hasPrevLevel,
        isPrevLevel,
        children: []
      };

      if (node.craftable && node.recipe.length && !visited.has(node.name)) {
        const next = new Set(visited);
        next.add(node.name);
        node.children = node.recipe.map(ing => buildTreeData(ing.item, ing.qty * qty, next, !!ing.isPrevLevel));
      }

      return node;
    }

    function buildUsesTreeData(name, qty = 1, visited = new Set(), maxDepth = 1, depth = 0) {
      const item = itemsMap.get(name) || { name, craftable: false, recipe: [], rarity: null };
      const node = {
        name: item.name,
        qty,
        craftable: !!(Array.isArray(item.recipe) && item.recipe.length),
        station: item.station || "",
        recipe: [],
        image: getItemImage(item.name),
        rarity: item.rarity || null,
        hasPrevLevel: false,
        isPrevLevel: false,
        children: []
      };

      if (depth >= maxDepth) return node;

      if (!visited.has(node.name)) {
        const next = new Set(visited);
        next.add(node.name);
        const uses = (usesMap.get(node.name) || [])
          .slice()
          .sort((a, b) => getItemLabelByName(a.name).localeCompare(getItemLabelByName(b.name)));
        node.children = uses.map(entry => buildUsesTreeData(entry.name, entry.qty, next, maxDepth, depth + 1));
      }

      return node;
    }

    function buildRecycleTreeData(name, qty = 1, visited = new Set(), maxDepth = 1, depth = 0) {
      const item = itemsMap.get(name) || { name, craftable: false, recipe: [], rarity: null };
      const node = {
        name: item.name,
        qty,
        craftable: !!(Array.isArray(item.recipe) && item.recipe.length),
        station: item.station || "",
        recipe: [],
        image: getItemImage(item.name),
        rarity: item.rarity || null,
        hasPrevLevel: false,
        isPrevLevel: false,
        children: []
      };

      if (depth >= maxDepth) return node;

      if (!visited.has(node.name)) {
        const next = new Set(visited);
        next.add(node.name);
        const sources = (recycleMap.get(node.name) || [])
          .slice()
          .sort((a, b) => getItemLabelByName(a.name).localeCompare(getItemLabelByName(b.name)));
        node.children = sources.map(entry => buildRecycleTreeData(entry.name, entry.qty, next, maxDepth, depth + 1));
      }

      return node;
    }

    function buildForestData() {
      const children = [];
      const selection = getActiveSelection();
      selection.forEach((qty, name) => {
        const node = state.board === "uses"
          ? buildUsesTreeData(name, qty, new Set(), getUsesDepth(name), 0)
          : state.board === "recycle"
            ? buildRecycleTreeData(name, qty, new Set(), 1, 0)
            : buildTreeData(name, qty);
        children.push(node);
      });
      return {
        name: "Selected",
        qty: 1,
        craftable: false,
        station: "",
        recipe: [],
        image: null,
        children
      };
    }

    function addSelection(name, delta = 1, dropCoords = null) {
      const selection = getActiveSelection();
      const positions = getActivePositions();
      const current = selection.get(name) || 0;
      const isNew = current === 0;
      const wasEmpty = selection.size === 0;
      const next = current + delta;
      if (next <= 0) {
        selection.delete(name);
        positions.delete(name);
      } else {
        selection.set(name, next);
        // If it's a new item and we have drop coordinates, use them
        if (isNew && dropCoords) {
          positions.set(name, { x: dropCoords.x, y: dropCoords.y });
        }
      }
      saveCurrentState();
      renderAll();

      // Auto-center when adding first item to empty board
      if (wasEmpty && selection.size === 1 && isNew) {
        setTimeout(centerViewOnAll, 50);
      }
    }

    function clearSelection() {
      const selection = getActiveSelection();
      const positions = getActivePositions();
      selection.clear();
      positions.clear();
      // Reset zoom to default when clearing
      setActiveZoom(d3.zoomIdentity);
      saveCurrentState();
      renderAll();
    }

    function centerViewOnAll() {
      const positions = getActivePositions();
      if (positions.size === 0) return;

      const svg = ui.tree;
      const width = svg.clientWidth || 900;
      const height = svg.clientHeight || 600;

      // Calculate bounding box of all tree positions
      const posArray = Array.from(positions.values());
      const minX = Math.min(...posArray.map(p => p.x)) - 150;
      const maxX = Math.max(...posArray.map(p => p.x)) + 500; // Account for tree width
      const minY = Math.min(...posArray.map(p => p.y)) - 150;
      const maxY = Math.max(...posArray.map(p => p.y)) + 400; // Account for tree height

      const contentWidth = maxX - minX;
      const contentHeight = maxY - minY;

      // Calculate scale to fit all content with some padding
      const padding = 80;
      const scaleX = (width - padding * 2) / contentWidth;
      const scaleY = (height - padding * 2) / contentHeight;
      const scale = Math.min(scaleX, scaleY, 1.2); // Cap max zoom (don't zoom in too much)
      const finalScale = Math.max(scale, 0.3); // Min zoom

      // Calculate center of content
      const centerX = (minX + maxX) / 2;
      const centerY = (minY + maxY) / 2;

      // Calculate transform to center the content
      const translateX = width / 2 - centerX * finalScale;
      const translateY = height / 2 - centerY * finalScale;

      const newTransform = d3.zoomIdentity
        .translate(translateX, translateY)
        .scale(finalScale);

      setActiveZoom(newTransform);
      saveCurrentState();

      // Animate the transition with zoom handler
      const svgSel = d3.select(svg);
      const board = svgSel.select(".board");
      const zoom = d3.zoom()
        .scaleExtent([0.4, 2.4])
        .on("zoom", event => {
          setActiveZoom(event.transform);
          board.attr("transform", event.transform);
        });

      svgSel.transition()
        .duration(400)
        .call(zoom.transform, newTransform);
    }

    function getViewCenter() {
      const svg = ui.tree;
      const width = svg.clientWidth || 900;
      const height = svg.clientHeight || 600;
      const transform = getActiveZoom();
      // Convert screen center to board coordinates
      const centerX = (width / 2 - transform.x) / transform.k;
      const centerY = (height / 2 - transform.y) / transform.k;
      return { x: centerX, y: centerY };
    }

    function findNonOverlappingPosition(baseX, baseY, existingPositions) {
      const minDistance = 500; // Minimum distance between tree roots (increased for better spacing)
      const positions = Array.from(existingPositions.values());

      // If no existing positions or base position is free, use it
      if (positions.length === 0) return { x: baseX, y: baseY };

      // Check if base position is far enough from all others
      const isFree = positions.every(pos => {
        const dx = pos.x - baseX;
        const dy = pos.y - baseY;
        return Math.sqrt(dx * dx + dy * dy) >= minDistance;
      });

      if (isFree) return { x: baseX, y: baseY };

      // Spiral outward to find a free spot
      const spiralStep = 100;
      for (let radius = spiralStep; radius < 2000; radius += spiralStep) {
        for (let angle = 0; angle < Math.PI * 2; angle += Math.PI / 4) {
          const testX = baseX + Math.cos(angle) * radius;
          const testY = baseY + Math.sin(angle) * radius;
          const testFree = positions.every(pos => {
            const dx = pos.x - testX;
            const dy = pos.y - testY;
            return Math.sqrt(dx * dx + dy * dy) >= minDistance;
          });
          if (testFree) return { x: testX, y: testY };
        }
      }

      // Fallback: place below the lowest existing position
      const maxY = Math.max(...positions.map(p => p.y));
      return { x: baseX, y: maxY + 300 };
    }

    function syncTreePositions() {
      const selection = getActiveSelection();
      const positions = getActivePositions();
      Array.from(positions.keys()).forEach(name => {
        if (!selection.has(name)) positions.delete(name);
      });
      const names = Array.from(selection.keys());

      names.forEach((name) => {
        if (!positions.has(name)) {
          // New item without position - place in view center, avoiding overlaps
          const center = getViewCenter();
          const freePos = findNonOverlappingPosition(center.x, center.y, positions);
          positions.set(name, freePos);
        }
      });
    }

    function renderList() {
      const query = ui.search.value.trim().toLowerCase();
      ui.categoryList.innerHTML = "";

      const eligible = items.filter(item => {
        if (item.name === "?") return false;
        if (state.board === "craft" && !item.craftable) return false;
        return matchesQuery(item, query);
      });
      const assigned = new Set();

      function createItemRow(item) {
        const rarity = normalizeRarity(item.rarity);
        const li = document.createElement("li");
        if (rarity) li.classList.add(`rarity-${rarity}`);
        li.draggable = true;
        li.dataset.name = item.name;
        const img = document.createElement("img");
        const imgSrc = getItemImage(item.name);
        if (imgSrc) {
          img.src = imgSrc;
        } else {
          img.alt = "";
          img.style.visibility = "hidden";
        }
        li.appendChild(img);
        li.appendChild(document.createTextNode(getItemLabel(item)));
        const tag = document.createElement("span");
        tag.className = `tag ${item.craftable ? "craft" : "loot"}`;
        tag.textContent = item.craftable ? t("craftTag") : t("lootTag");
        li.appendChild(tag);

        li.addEventListener("dragstart", event => {
          event.dataTransfer.setData("text/plain", item.name);
        });

        li.addEventListener("click", () => {
          addSelection(item.name, 1);
        });

        return li;
      }

      function addCategory(key, members, forceShow) {
        const label = (categoryLabels[state.lang] && categoryLabels[state.lang][key]) ? categoryLabels[state.lang][key] : key;

        // Match explicit members AND their upgrades
        const categoryMembers = new Set(members);
        const filteredNames = eligible
          .filter(item => {
            if (assigned.has(item.name)) return false;
            const baseName = getBaseName(item.name);
            const isMatch = categoryMembers.has(item.name) || categoryMembers.has(baseName);

            // Smarter interpretation for Grenades
            if (key === "Grenades") {
              const nameLower = item.name.toLowerCase();
              const nameEsLower = (item.name_es || "").toLowerCase();
              if (nameLower.includes("grenade") || nameEsLower.includes("granada")) return true;
            }

            return isMatch;
          })
          .map(item => item.name);

        if (!filteredNames.length && !forceShow) return;

        const detail = document.createElement("details");
        detail.className = "category";
        if (query) detail.open = true;
        const summary = document.createElement("summary");
        summary.textContent = `${label} (${filteredNames.length})`;
        detail.appendChild(summary);

        if (filteredNames.length) {
          filteredNames.forEach(name => assigned.add(name));
          const list = document.createElement("ul");
          list.className = "item-list";
          filteredNames
            .map(name => itemsMap.get(name))
            .filter(Boolean)
            .sort((a, b) => getItemLabel(a).localeCompare(getItemLabel(b)))
            .forEach(item => list.appendChild(createItemRow(item)));
          detail.appendChild(list);
        } else {
          const empty = document.createElement("div");
          empty.className = "summary-empty";
          empty.textContent = t("noFilterItems");
          detail.appendChild(empty);
        }

        ui.categoryList.appendChild(detail);
      }

      const order = (categories.order && categories.order.length) ? categories.order : [];
      order
        .filter(key => key !== "Grenades" && key !== "Traps")
        .forEach(key => {
          const members = (categories.members && categories.members[key]) ? categories.members[key] : [];
          addCategory(key, members, !query);
        });

      const remaining = eligible.filter(item => !assigned.has(item.name));
      if (remaining.length) {
        const detail = document.createElement("details");
        detail.className = "category";
        if (query) detail.open = true;
        const summary = document.createElement("summary");
        summary.textContent = `${t("others")} (${remaining.length})`;
        detail.appendChild(summary);
        const list = document.createElement("ul");
        list.className = "item-list";
        remaining
          .sort((a, b) => getItemLabel(a).localeCompare(getItemLabel(b)))
          .forEach(item => list.appendChild(createItemRow(item)));
        detail.appendChild(list);
        ui.categoryList.appendChild(detail);
      }
    }

    function renderSelection() {
      ui.selectedChips.innerHTML = "";
      const selection = getActiveSelection();
      const entries = Array.from(selection.entries());
      entries.forEach(([name, qty]) => {
        const item = itemsMap.get(name) || {};
        const rarity = normalizeRarity(item.rarity);
        const chip = document.createElement("span");
        chip.className = `chip${rarity ? " rarity-" + rarity : ""}`;
        const label = getItemLabel(item) || name;
        chip.textContent = `${label}${qty > 1 ? " x" + qty : ""}`;
        const remove = document.createElement("button");
        remove.type = "button";
        remove.textContent = "√ó";
        remove.addEventListener("click", () => {
          selection.delete(name);
          saveCurrentState();
          renderAll();
        });
        chip.appendChild(remove);
        ui.selectedChips.appendChild(chip);
      });

      // Toggle selection bar visibility
      if (ui.selectionBar) {
        ui.selectionBar.classList.toggle("has-items", entries.length > 0);
      }
    }

    function renderTree() {
      const selection = getActiveSelection();
      if (selection.size === 0) {
        const svg = d3.select(ui.tree);
        svg.selectAll("*").remove();
        return;
      }

      syncTreePositions();
      const positions = getActivePositions();
      const currentZoom = getActiveZoom();

      const svg = d3.select(ui.tree);
      svg.selectAll("*").remove();

      const width = svg.node().clientWidth || 900;
      const height = svg.node().clientHeight || 600;
      svg.attr("viewBox", `0 0 ${width} ${height}`);

      const defs = svg.append("defs");
      const board = svg.append("g").attr("class", "board");
      board.attr("transform", currentZoom);

      let clipIndex = 0;
      function makeClipId(name) {
        clipIndex += 1;
        return `clip-${name.replace(/[^a-z0-9]/gi, "")}-${clipIndex}`;
      }

      const dragTree = d3.drag()
        .container(svg.node()) // Use SVG as container for consistent coordinate calculation
        .on("start", function (event) {
          if (event.sourceEvent) event.sourceEvent.stopPropagation();
          d3.select(this).classed("dragging", true);
        })
        .on("drag", function (event, d) {
          // Use raw mouse movement from sourceEvent for precise 1:1 tracking
          const sourceEvent = event.sourceEvent;
          if (!sourceEvent) return;

          const currentK = getActiveZoom().k;
          const pos = positions.get(d.name) || { x: 0, y: 0 };

          // movementX/Y gives actual pixel movement of mouse
          const dx = sourceEvent.movementX || 0;
          const dy = sourceEvent.movementY || 0;

          // Convert screen pixels to board coordinates
          pos.x += dx / currentK;
          pos.y += dy / currentK;
          positions.set(d.name, pos);
          d3.select(this)
            .attr("transform", `translate(${pos.x},${pos.y})`);
          saveCurrentState();
        })
        .on("end", function () {
          d3.select(this).classed("dragging", false);
          saveCurrentState();
        });

      selection.forEach((qty, name) => {
        const rootData = state.board === "uses"
          ? buildUsesTreeData(name, qty, new Set(), getUsesDepth(name), 0)
          : state.board === "recycle"
            ? buildRecycleTreeData(name, qty, new Set(), 1, 0)
            : buildTreeData(name, qty);
        const root = d3.hierarchy(rootData, d => d.children);
        const treeLayout = d3.tree().nodeSize([70, 190]);
        treeLayout(root);

        const offsetX = root.x;
        const offsetY = root.y;
        root.descendants().forEach(node => {
          node.x -= offsetX;
          node.y -= offsetY;
        });

        const group = board.append("g")
          .attr("class", "tree-group")
          .datum({ name })
          .call(dragTree);

        const pos = positions.get(name) || { x: 60, y: 60 };
        group.attr("transform", `translate(${pos.x},${pos.y})`);

        group.append("g")
          .selectAll("path")
          .data(root.links())
          .join("path")
          .attr("class", d => `link${d.target && d.target.data && d.target.data.isPrevLevel ? " prev-level" : ""}`)
          .attr("d", d3.linkHorizontal()
            .x(d => d.y)
            .y(d => d.x));

        const node = group.append("g")
          .selectAll("g")
          .data(root.descendants())
          .join("g")
          .attr("class", d => {
            const rarity = normalizeRarity(d.data.rarity);
            const prev = d.data.isPrevLevel ? " prev-level" : "";
            const hasPrev = d.data.hasPrevLevel ? " has-prev" : "";
            return `node ${d.data.craftable ? "craft" : "loot"}${rarity ? " rarity-" + rarity : ""}${prev}${hasPrev}`;
          })
          .attr("transform", d => `translate(${d.y},${d.x})`);

        node.each(function (d) {
          if (!d.data.image) return;
          const clipId = makeClipId(d.data.name);
          d.data.clipId = clipId;
          defs.append("clipPath")
            .attr("id", clipId)
            .append("circle")
            .attr("r", 14)
            .attr("cx", 0)
            .attr("cy", 0);
        });

        node.append("circle")
          .attr("r", 16);

        node.filter(d => d.data.image)
          .append("image")
          .attr("href", d => d.data.image)
          .attr("width", 28)
          .attr("height", 28)
          .attr("x", -14)
          .attr("y", -14)
          .attr("clip-path", d => d.data.clipId ? `url(#${d.data.clipId})` : null);

        node.append("text")
          .attr("x", d => d.data.hasPrevLevel ? 44 : 24)
          .attr("y", -4)
          .text(d => {
            if (state.board === "recycle" && d.depth > 0 && d.data.qty > 1) {
              return `${getItemLabelByName(d.data.name)} -> x${d.data.qty}`;
            }
            return `${d.data.qty > 1 ? "x" + d.data.qty + " " : ""}${getItemLabelByName(d.data.name)}`;
          });

        node.append("text")
          .attr("x", d => d.data.hasPrevLevel ? 44 : 24)
          .attr("y", 12)
          .attr("class", "status")
          .text(d => d.data.craftable ? t("craftable") : t("lootOnly"));

        node.each(function (d) {
          if (state.board !== "craft") return;
          if (!d.data.hasPrevLevel) return;
          const expanded = shouldShowPrevLevels(d.data.name);
          const toggle = d3.select(this)
            .append("g")
            .attr("class", "prev-toggle")
            .attr("transform", "translate(36,35)");

          toggle.append("circle").attr("r", 8);
          toggle.append("title").text(expanded ? t("prevLevelsHide") : t("prevLevelsShow"));
          toggle.append("text")
            .attr("class", "prev-toggle-label")
            .attr("text-anchor", "middle")
            .attr("dy", "0.35em")
            .text(expanded ? "-" : "+");

          toggle.on("click", (event) => {
            event.stopPropagation();
            togglePrevLevels(d.data.name);
          });
        });

        node.each(function (d) {
          if (state.board !== "uses") return;
          if (d.depth !== 0) return;
          const uses = usesMap.get(d.data.name) || [];
          if (!uses.length) return;
          const depth = getUsesDepth(d.data.name);
          const toggle = d3.select(this)
            .append("g")
            .attr("class", "depth-toggle")
            .attr("transform", "translate(36,35)");

          const minus = toggle.append("g")
            .attr("class", `depth-btn${depth <= 1 ? " is-disabled" : ""}`)
            .attr("transform", "translate(0,-12)");

          minus.append("circle").attr("r", 7);
          minus.append("text")
            .attr("class", "depth-toggle-label")
            .attr("text-anchor", "middle")
            .attr("dy", "0.35em")
            .text("-");
          minus.append("title").text(t("usesDepthLess"));

          minus.on("click", (event) => {
            event.stopPropagation();
            if (depth <= 1) return;
            adjustUsesDepth(d.data.name, -1);
          }); const plus = toggle.append("g")
            .attr("class", "depth-btn")
            .attr("transform", "translate(0,12)");

          plus.append("circle").attr("r", 7);
          plus.append("text")
            .attr("class", "depth-toggle-label")
            .attr("text-anchor", "middle")
            .attr("dy", "0.35em")
            .text("+");
          plus.append("title").text(t("usesDepthMore"));

          plus.on("click", (event) => {
            event.stopPropagation();
            adjustUsesDepth(d.data.name, 1);
          });
        });
      });



      const zoom = d3.zoom().scaleExtent([0.4, 2.4]).on("zoom", event => {
        setActiveZoom(event.transform);
        board.attr("transform", event.transform);
      });
      svg.call(zoom).on("dblclick.zoom", null);
      svg.call(zoom.transform, currentZoom);
    }

    function accumulateRequirements(name, qty, totals, baseTotals, stack) {
      const item = itemsMap.get(name) || { name, craftable: false, recipe: [], rarity: null };
      const recipe = getCombinedRecipe(item);
      const craftable = !!recipe.length;
      if (!totals.has(name)) {
        totals.set(name, { name, qty: 0, craftable, rarity: item.rarity || null });
      }
      totals.get(name).qty += qty;

      if (craftable && !stack.has(name)) {
        const next = new Set(stack);
        next.add(name);
        recipe.forEach(ing => {
          accumulateRequirements(ing.item, ing.qty * qty, totals, baseTotals, next);
        });
      } else {
        if (!baseTotals.has(name)) {
          baseTotals.set(name, { name, qty: 0, rarity: item.rarity || null });
        }
        baseTotals.get(name).qty += qty;
      }
    }

    function renderSummary() {
      ui.summaryList.innerHTML = "";
      const selection = getActiveSelection();

      if (selection.size === 0) {
        ui.summaryEmpty.style.display = "block";
        return;
      }
      ui.summaryEmpty.style.display = "none";

      if (state.board === "uses") {
        const usesTotals = new Map();
        selection.forEach((qty, name) => {
          const uses = usesMap.get(name) || [];
          uses.forEach(entry => {
            if (usesTotals.has(entry.name)) return;
            const usedItem = itemsMap.get(entry.name) || {};
            usesTotals.set(entry.name, {
              name: entry.name,
              qty: entry.qty,
              craftable: true,
              rarity: usedItem.rarity || null
            });
          });
        });

        const list = Array.from(usesTotals.values())
          .sort((a, b) => getItemLabelByName(a.name).localeCompare(getItemLabelByName(b.name)));

        if (list.length === 0) {
          const empty = document.createElement("li");
          empty.className = "summary-item";
          empty.textContent = t("noUses");
          ui.summaryList.appendChild(empty);
        } else {
          list.forEach(entry => {
            const li = document.createElement("li");
            const rarity = normalizeRarity(entry.rarity);
            li.className = `summary-item${rarity ? " rarity-" + rarity : ""}`;

            const img = document.createElement("img");
            const imgSrc = getItemImage(entry.name);
            if (imgSrc) img.src = imgSrc;
            else img.style.visibility = "hidden";

            const info = document.createElement("div");
            info.className = "item-info";

            const nameSpan = document.createElement("div");
            nameSpan.className = "name";
            nameSpan.textContent = getItemLabelByName(entry.name);

            const meta = document.createElement("div");
            meta.className = "meta";

            const tag = document.createElement("span");
            tag.className = "tag craft";
            tag.textContent = t("craftTag");

            const qty = document.createElement("span");
            qty.className = "qty";
            qty.textContent = `x${entry.qty}`;

            meta.appendChild(tag);
            meta.appendChild(qty);
            info.appendChild(nameSpan);
            info.appendChild(meta);

            li.appendChild(img);
            li.appendChild(info);
            ui.summaryList.appendChild(li);
          });
        }
        return;
      }

      if (state.board === "recycle") {
        const recycleTotals = new Map();
        selection.forEach((qty, name) => {
          const sources = recycleMap.get(name) || [];
          sources.forEach(entry => {
            if (recycleTotals.has(entry.name)) return;
            const sourceItem = itemsMap.get(entry.name) || {};
            recycleTotals.set(entry.name, {
              name: entry.name,
              qty: entry.qty,
              craftable: !!(sourceItem.recipe && sourceItem.recipe.length),
              rarity: sourceItem.rarity || null
            });
          });
        });

        const list = Array.from(recycleTotals.values())
          .sort((a, b) => getItemLabelByName(a.name).localeCompare(getItemLabelByName(b.name)));

        if (list.length === 0) {
          const empty = document.createElement("li");
          empty.className = "summary-item";
          empty.textContent = t("noRecycle");
          ui.summaryList.appendChild(empty);
        } else {
          list.forEach(entry => {
            const li = document.createElement("li");
            const rarity = normalizeRarity(entry.rarity);
            li.className = `summary-item${rarity ? " rarity-" + rarity : ""}`;

            const img = document.createElement("img");
            const imgSrc = getItemImage(entry.name);
            if (imgSrc) img.src = imgSrc;
            else img.style.visibility = "hidden";

            const info = document.createElement("div");
            info.className = "item-info";

            const nameSpan = document.createElement("div");
            nameSpan.className = "name";
            nameSpan.textContent = getItemLabelByName(entry.name);

            const meta = document.createElement("div");
            meta.className = "meta";

            const tag = document.createElement("span");
            tag.className = "tag recycle";
            tag.textContent = t("recycleTag");

            const qtySpan = document.createElement("span");
            qtySpan.className = "qty";
            qtySpan.textContent = `x${entry.qty}`;

            meta.appendChild(tag);
            meta.appendChild(qtySpan);
            info.appendChild(nameSpan);
            info.appendChild(meta);

            li.appendChild(img);
            li.appendChild(info);
            ui.summaryList.appendChild(li);
          });
        }
        return;
      }

      const totals = new Map();
      const baseTotals = new Map();

      selection.forEach((qty, name) => {
        const item = itemsMap.get(name);
        if (!item) return;
        const recipe = getCombinedRecipe(item);
        if (!recipe.length) return;
        recipe.forEach(ing => {
          accumulateRequirements(ing.item, ing.qty * qty, totals, baseTotals, new Set([name]));
        });
      });

      const getRarityValue = (rarity) => {
        const lower = String(rarity || "").toLowerCase();
        if (lower.includes("legend")) return 5;
        if (lower.includes("epic")) return 4;
        if (lower.includes("rare")) return 3;
        if (lower.includes("uncommon")) return 2;
        if (lower.includes("common")) return 1;
        return 0;
      };

      const customSort = (a, b) => {
        if (sortMode === "rarity") {
          const valA = getRarityValue(a.rarity);
          const valB = getRarityValue(b.rarity);
          if (valB !== valA) return valB - valA;
        }
        return getItemLabelByName(a.name).localeCompare(getItemLabelByName(b.name));
      };

      const totalList = Array.from(totals.values()).sort(customSort);

      if (totalList.length === 0) {
        const empty = document.createElement("li");
        empty.className = "summary-item";
        empty.textContent = t("noMaterials");
        ui.summaryList.appendChild(empty);
      } else {
        totalList.forEach(entry => {
          const li = document.createElement("li");
          const rarity = normalizeRarity(entry.rarity);
          li.className = `summary-item${rarity ? " rarity-" + rarity : ""}`;

          const img = document.createElement("img");
          const imgSrc = getItemImage(entry.name);
          if (imgSrc) img.src = imgSrc;
          else img.style.visibility = "hidden";

          const info = document.createElement("div");
          info.className = "item-info";

          const nameSpan = document.createElement("div");
          nameSpan.className = "name";
          nameSpan.textContent = getItemLabelByName(entry.name);

          const meta = document.createElement("div");
          meta.className = "meta";

          const tag = document.createElement("span");
          tag.className = `tag ${entry.craftable ? "craft" : "loot"}`;
          tag.textContent = entry.craftable ? t("craftTag") : t("lootTag");

          const qty = document.createElement("span");
          qty.className = "qty";
          qty.textContent = `x${entry.qty}`;

          meta.appendChild(tag);
          meta.appendChild(qty);
          info.appendChild(nameSpan);
          info.appendChild(meta);

          li.appendChild(img);
          li.appendChild(info);
          ui.summaryList.appendChild(li);
        });
      }
    }

    function bindDrop() {
      function screenToBoardCoords(clientX, clientY) {
        const svg = ui.tree;
        const rect = svg.getBoundingClientRect();
        const screenX = clientX - rect.left;
        const screenY = clientY - rect.top;
        const transform = getActiveZoom();
        // Convert screen coordinates to board coordinates
        const boardX = (screenX - transform.x) / transform.k;
        const boardY = (screenY - transform.y) / transform.k;
        return { x: boardX, y: boardY };
      }

      function handleDrop(event) {
        event.preventDefault();
        ui.dropzone.classList.remove("active");
        const name = event.dataTransfer.getData("text/plain");
        if (name) {
          // Get drop position in board coordinates
          const dropCoords = screenToBoardCoords(event.clientX, event.clientY);
          const positions = getActivePositions();
          // Find non-overlapping position near drop point
          const freePos = findNonOverlappingPosition(dropCoords.x, dropCoords.y, positions);
          addSelection(name, 1, freePos);
        }
      }

      function handleOver(event) {
        event.preventDefault();
        ui.dropzone.classList.add("active");
        const workspace = ui.tree.closest(".workspace");
        if (workspace) workspace.classList.add("drag-over");
      }

      function handleLeave(event) {
        // Only remove if we're actually leaving the workspace
        const workspace = ui.tree.closest(".workspace");
        const related = event.relatedTarget;
        if (!workspace || !related || !workspace.contains(related)) {
          ui.dropzone.classList.remove("active");
          if (workspace) workspace.classList.remove("drag-over");
        }
      }

      function handleDropEnd() {
        ui.dropzone.classList.remove("active");
        const workspace = ui.tree.closest(".workspace");
        if (workspace) workspace.classList.remove("drag-over");
      }

      ui.dropzone.addEventListener("dragover", handleOver);
      ui.dropzone.addEventListener("dragleave", handleLeave);
      ui.dropzone.addEventListener("drop", (e) => { handleDrop(e); handleDropEnd(); });
      ui.tree.addEventListener("dragover", handleOver);
      ui.tree.addEventListener("dragleave", handleLeave);
      ui.tree.addEventListener("drop", (e) => { handleDrop(e); handleDropEnd(); });
    }

    function renderAll() {
      renderSelection();
      renderTree();
      renderSummary();
    }

    function applyBoardUI() {
      ui.boardCraft.textContent = t("boardCraft");
      ui.boardUses.textContent = t("boardUses");
      ui.boardRecycle.textContent = t("boardRecycle");
      ui.boardCraft.classList.toggle("active", state.board === "craft");
      ui.boardUses.classList.toggle("active", state.board === "uses");
      ui.boardRecycle.classList.toggle("active", state.board === "recycle");
      ui.dropzone.dataset.text = state.board === "craft"
        ? t("dropzoneCraft")
        : state.board === "uses"
          ? t("dropzoneUses")
          : t("dropzoneRecycle");
      ui.summaryTitle.textContent = state.board === "craft"
        ? t("summaryTitleCraft")
        : state.board === "uses"
          ? t("summaryTitleUses")
          : t("summaryTitleRecycle");
      ui.summaryEmpty.textContent = state.board === "craft"
        ? t("summaryEmptyCraft")
        : state.board === "uses"
          ? t("summaryEmptyUses")
          : t("summaryEmptyRecycle");
      ui.sortSummary.style.display = state.board === "craft" ? "" : "none";
    }

    function openGuideModal() {
      ui.guideModal.classList.add("open");
      ui.guideModal.setAttribute("aria-hidden", "false");
    }

    function closeGuideModal() {
      ui.guideModal.classList.remove("open");
      ui.guideModal.setAttribute("aria-hidden", "true");
    }

    function applyLanguage() {
      document.documentElement.lang = state.lang;
      document.title = t("title");
      ui.categoriesTitle.textContent = t("categories");
      ui.search.placeholder = t("searchPlaceholder");
      ui.clearSelection.textContent = t("clearSelection");
      ui.toggleSidebar.title = t("toggleSidebar");
      ui.toggleSummary.title = t("toggleSummary");
      ui.centerView.title = t("centerView");
      ui.openGuide.textContent = t("openGuide");
      ui.closeGuide.textContent = t("closeGuide");
      ui.guideTitle.textContent = t("guideTitle");
      // Save/Share buttons
      ui.saveBoardBtn.textContent = t("saveBoard");
      ui.shareBoardBtn.textContent = t("shareBoard");
      ui.shareBannerText.textContent = t("sharedBannerText");
      ui.shareSaveBtn.textContent = t("saveCopy");
      // Boards drawer
      ui.boardsTitle.textContent = t("boardDrawerTitle");
      if (ui.boardsHandleTitle) ui.boardsHandleTitle.textContent = "üìÅ " + t("boardDrawerTitle");
      ui.newBoardBtn.textContent = t("boardNew");
      ui.boardsEmpty.textContent = t("boardEmpty");
      // Board modal
      ui.boardModalTitle.textContent = boardModalMode === "rename" ? t("boardRenameTitle") : t("boardNewTitle");
      ui.boardNameLabel.textContent = t("boardNameLabel");
      ui.boardSave.textContent = t("boardSave");
      ui.boardCancel.textContent = t("boardCancel");
      ui.boardModalClose.textContent = t("modalClose");
      ui.langToggle.textContent = state.lang === "es" ? "EN" : "ES";
      applyBoardUI();
      updateBoardsUI();
      saveCurrentState();
      renderList();
      renderAll();
    }

    function setBoard(board) {
      if (state.board === board) return;
      state.board = board;
      applyBoardUI();
      saveCurrentState();
      renderList();
      renderAll();
    }

    function init() {
      loadInitialState();
      bindDrop();
      ui.search.addEventListener("input", renderList);
      ui.clearSelection.addEventListener("click", clearSelection);
      ui.centerView.addEventListener("click", centerViewOnAll);
      ui.boardCraft.addEventListener("click", () => setBoard("craft"));
      ui.boardUses.addEventListener("click", () => setBoard("uses"));
      ui.boardRecycle.addEventListener("click", () => setBoard("recycle"));
      ui.openGuide.addEventListener("click", openGuideModal);
      ui.closeGuide.addEventListener("click", closeGuideModal);
      ui.guideBackdrop.addEventListener("click", closeGuideModal);
      ui.langToggle.addEventListener("click", () => {
        state.lang = state.lang === "es" ? "en" : "es";
        applyLanguage();
      });

      // Save/Share buttons
      ui.saveBoardBtn.addEventListener("click", handleSave);
      ui.shareBoardBtn.addEventListener("click", handleShare);
      ui.shareSaveBtn.addEventListener("click", handleSaveSharedBoard);
      ui.shareDismissBtn.addEventListener("click", hideShareBanner);

      // Board modal
      ui.newBoardBtn.addEventListener("click", () => openBoardModal("new"));
      ui.boardCancel.addEventListener("click", closeBoardModal);
      ui.boardModalClose.addEventListener("click", closeBoardModal);
      ui.boardBackdrop.addEventListener("click", closeBoardModal);
      ui.boardForm.addEventListener("submit", handleBoardFormSubmit);
      document.addEventListener("click", (event) => {
        // Close control panel when clicking outside
        if (ui.controlPanel && ui.controlPanel.classList.contains("is-open") &&
          !ui.controlPanel.contains(event.target)) {
          ui.controlPanel.classList.remove("is-open");
        }
        // Close share dropdown when clicking outside
        if (ui.shareDropdown && ui.shareDropdown.classList.contains("is-open") &&
          !ui.shareDropdown.contains(event.target) &&
          !event.target.closest('.share-trigger')) {
          ui.shareDropdown.classList.remove("is-open");
        }
      });

      // Control Panel trigger
      if (ui.controlTrigger) {
        ui.controlTrigger.addEventListener("click", (event) => {
          event.stopPropagation();
          ui.controlPanel.classList.toggle("is-open");
        });
      }

      // Share dropdown toggle
      if (ui.shareBoardBtn) {
        ui.shareBoardBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          ui.shareDropdown.classList.toggle("is-open");
        });
      }

      // Share options
      document.querySelectorAll('.share-option').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const action = e.currentTarget.dataset.action;
          handleShareAction(action);
          ui.shareDropdown.classList.remove("is-open");
        });
      });

      // Resizing logic
      let isResizing = false;
      ui.summaryResizer.addEventListener("mousedown", (e) => {
        isResizing = true;
        document.body.style.cursor = "ew-resize";
        document.body.style.userSelect = "none";
        ui.summaryPanel.style.transition = "none";
      });

      window.addEventListener("mousemove", (e) => {
        if (!isResizing) return;
        const width = window.innerWidth - e.clientX;
        document.documentElement.style.setProperty("--summary-width", `${width}px`);
      });

      window.addEventListener("mouseup", () => {
        if (!isResizing) return;
        isResizing = false;
        document.body.style.cursor = "";
        document.body.style.userSelect = "";
        ui.summaryPanel.style.transition = "";
        setTimeout(renderTree, 100);
      });

      // Sorting logic
      ui.sortSummary.addEventListener("click", () => {
        sortMode = sortMode === "name" ? "rarity" : "name";
        ui.sortSummary.classList.toggle("active", sortMode === "rarity");
        saveCurrentState();
        renderSummary();
      });

      const toggleSide = () => {
        document.body.classList.toggle("menu-collapsed");
        setTimeout(renderTree, 400);
      };

      const toggleSumm = () => {
        document.body.classList.toggle("summary-collapsed");
        setTimeout(renderTree, 400);
      };

      ui.toggleSidebar.addEventListener("click", toggleSide);
      ui.toggleSummary.addEventListener("click", toggleSumm);

      window.addEventListener("resize", renderTree);
      window.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeGuideModal();
          closeLoginModal();
          closeBoardModal();
          if (ui.controlPanel) ui.controlPanel.classList.remove("is-open");
        }
      });
      applyLanguage();
    }

    init();
  </script>
</body>

</html>